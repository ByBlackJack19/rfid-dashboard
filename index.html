<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tus Estad√≠sticas de Spotify</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #121212; color: white; font-family: sans-serif; }
    .spotify-green { background: #1DB954; }
    .spotify-dark { background: #191414; }
    #debug { margin-top: 20px; padding: 10px; border: 1px solid red; color: #ff6b6b; background: #2b2b2b; white-space: pre-wrap; }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

  <div id="app-container" class="w-full max-w-4xl p-8 rounded-lg shadow-xl spotify-dark">
    <div id="login-section">
      <h1 class="text-4xl font-bold mb-4">Tus Estad√≠sticas de Spotify</h1>
      <button id="login" class="spotify-green text-white font-bold py-3 px-8 rounded-full">
        Iniciar Sesi√≥n con Spotify
      </button>
    </div>
    <div id="stats-section" class="hidden">
      <h2 id="user-greeting"></h2>
      <button id="logout" class="mt-4 bg-red-600 px-4 py-2 rounded">Cerrar Sesi√≥n</button>
    </div>
    <div id="debug"></div> <!-- DEBUG AREA -->
  </div>

  <script>
    const clientId = "682780c12e3047d2ad0986d34edd6c96";
    const redirectUri = "https://byblackjack19.github.io/rfid-dashboard/index.html";
    const scopes = "user-read-private user-read-email user-top-read playlist-read-private playlist-modify-public playlist-modify-private";
    let accessToken = null;

    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const loginSection = document.getElementById("login-section");
    const statsSection = document.getElementById("stats-section");
    const debugDiv = document.getElementById("debug");
    const userGreeting = document.getElementById("user-greeting");

    function debug(msg, error) {
      console.error(msg, error || "");
      debugDiv.textContent += "\n" + msg + (error ? " ‚Üí " + error : "");
    }

    // Llamada a la API de Spotify para obtener info del usuario
    async function getUserProfile() {
      try {
        const response = await fetch("https://api.spotify.com/v1/me", {
          headers: { Authorization: `Bearer ${accessToken}` }
        });

        if (!response.ok) {
          throw new Error("Error en la petici√≥n: " + response.status);
        }

        const data = await response.json();
        userGreeting.innerText = `Hola, ${data.display_name} üëã`;
        debug("Usuario cargado correctamente: " + data.display_name);
      } catch (err) {
        debug("Error al obtener perfil de usuario", err);
      }
    }

    loginBtn.addEventListener("click", () => {
      try {
        const url = new URL("https://accounts.spotify.com/authorize");
        url.searchParams.append("client_id", clientId);
        url.searchParams.append("response_type", "token");
        url.searchParams.append("redirect_uri", redirectUri);
        url.searchParams.append("scope", scopes);
        window.location = url.toString();
      } catch (err) {
        debug("Error al iniciar login", err);
      }
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.clear();
      window.location.reload();
    });

    window.onload = () => {
      try {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        accessToken = params.get("access_token") || localStorage.getItem("access_token");

        if (accessToken) {
          localStorage.setItem("access_token", accessToken);
          loginSection.classList.add("hidden");
          statsSection.classList.remove("hidden");
          debug("Access token detectado. Obteniendo perfil...");
          getUserProfile(); // <-- Aqu√≠ pedimos el nombre del usuario
        } else {
          debug("No hay token. Mostrar login.");
          loginSection.classList.remove("hidden");
          statsSection.classList.add("hidden");
        }
      } catch (err) {
        debug("Error cr√≠tico en onload", err);
      }
    };
  </script>
</body>
</html>
