<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tus Estadísticas de Spotify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #ffffff;
        }
        .spotify-green {
            background-color: #1DB954;
        }
        .spotify-dark {
            background-color: #191414;
        }
        .tab-active {
            border-bottom-width: 2px;
            border-color: #1DB954;
            color: #ffffff;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div id="app-container" class="w-full max-w-4xl p-8 rounded-lg shadow-xl spotify-dark">
        <!-- Contenido de la app -->
        <div id="login-section" class="flex flex-col items-center justify-center text-center">
            <h1 class="text-4xl font-bold mb-4">Tus Estadísticas de Spotify</h1>
            <p class="text-gray-400 mb-6">Inicia sesión para ver tus artistas y canciones más escuchadas.</p>
            <button id="login" class="spotify-green text-white font-bold py-3 px-8 rounded-full transition-transform transform hover:scale-105">
                Iniciar Sesión con Spotify
            </button>
        </div>
        
        <div id="stats-section" class="hidden">
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center">
                    <img id="user-image" src="" class="rounded-full w-12 h-12 mr-4 hidden"/>
                    <h2 id="user-greeting" class="text-2xl font-bold"></h2>
                </div>
                <button id="logout" class="bg-gray-700 text-white py-2 px-6 rounded-full hover:bg-gray-600 transition-colors">Cerrar Sesión</button>
            </header>
            
            <div class="flex justify-center mb-6 border-b border-gray-600">
                <button id="artists-tab" class="py-3 px-6 text-gray-400 font-semibold border-b-2 border-transparent transition-colors hover:text-white">Artistas</button>
                <button id="tracks-tab" class="py-3 px-6 text-gray-400 font-semibold border-b-2 border-transparent transition-colors hover:text-white">Canciones</button>
                <button id="playlists-tab" class="py-3 px-6 text-gray-400 font-semibold border-b-2 border-transparent transition-colors hover:text-white">Playlists (CRUD)</button>
            </div>
            
            <div id="artists-content" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            <div id="tracks-content" class="hidden"></div>
            
            <!-- Sección CRUD de Playlists -->
            <div id="playlists-content" class="hidden">
                <div class="mb-6 p-4 rounded-lg bg-gray-800">
                    <h3 class="text-xl font-bold mb-2">Crear Playlist (CREATE)</h3>
                    <p class="text-gray-400 mb-4">Crea una nueva lista de reproducción con tus 50 canciones más escuchadas.</p>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="playlist-name-input" class="flex-1 bg-gray-900 text-white border border-gray-700 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-spotify-green" placeholder="Nombre de la nueva playlist">
                        <button id="create-playlist-btn" class="spotify-green text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">
                            Crear
                        </button>
                    </div>
                </div>
                
                <h3 class="text-xl font-bold mb-4">Tus Playlists (READ, UPDATE, DELETE)</h3>
                <div id="user-playlists" class="space-y-4">
                    <p class="text-center text-gray-400">Cargando playlists...</p>
                </div>
            </div>
        </div>
        
        <div id="loading-spinner" class="hidden flex justify-center mt-8">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-gray-200 border-t-spotify-green"></div>
        </div>
        
        <!-- Contenedor del mensaje flotante -->
        <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h4 id="message-title" class="text-lg font-bold mb-2"></h4>
                <p id="message-text" class="text-gray-300 mb-4"></p>
                <div class="flex justify-end space-x-2">
                    <button id="confirm-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-full hover:bg-red-600 transition-colors hidden">Sí</button>
                    <button id="cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-full hover:bg-gray-500 transition-colors hidden">No</button>
                    <button id="ok-btn" class="spotify-green text-white font-bold py-2 px-4 rounded-full hover:bg-green-600 transition-colors hidden">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // CONFIGURACIÓN DE LA APLICACIÓN
        // ===================================
        const clientId = "682780c12e3047d2ad0986d34edd6c96";
        const redirectUri = "https://byblackjack19.github.io/rfid-dashboard/index.html";
        // Nuevos permisos para gestionar playlists
        const scopes = "user-read-private user-read-email user-top-read playlist-read-private playlist-modify-public playlist-modify-private";
        let accessToken = null;
        let userId = null;

        // ===================================
        // FUNCIONES DE AUTENTICACIÓN PKCE
        // ===================================

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function base64encode(buffer) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=+$/, "");
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest("SHA-256", data);
            return base64encode(digest);
        }

        // ===================================
        // GESTIÓN DEL FLUJO DE AUTENTICACIÓN
        // ===================================

        const loginBtn = document.getElementById("login");
        const logoutBtn = document.getElementById("logout");
        const loginSection = document.getElementById("login-section");
        const statsSection = document.getElementById("stats-section");
        const loadingSpinner = document.getElementById("loading-spinner");
        const artistsTab = document.getElementById("artists-tab");
        const tracksTab = document.getElementById("tracks-tab");
        const playlistsTab = document.getElementById("playlists-tab");
        const artistsContent = document.getElementById("artists-content");
        const tracksContent = document.getElementById("tracks-content");
        const playlistsContent = document.getElementById("playlists-content");
        
        // Elementos CRUD
        const createPlaylistBtn = document.getElementById("create-playlist-btn");
        const playlistNameInput = document.getElementById("playlist-name-input");
        const userPlaylistsDiv = document.getElementById("user-playlists");
        
        // Elementos del modal de mensaje
        const messageModal = document.getElementById("message-modal");
        const messageTitle = document.getElementById("message-title");
        const messageText = document.getElementById("message-text");
        const confirmBtn = document.getElementById("confirm-btn");
        const cancelBtn = document.getElementById("cancel-btn");
        const okBtn = document.getElementById("ok-btn");

        loginBtn.addEventListener("click", async () => {
            const codeVerifier = generateRandomString(128);
            localStorage.setItem("code_verifier", codeVerifier);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const authUrl = new URL("https://accounts.spotify.com/authorize");
            authUrl.searchParams.append("client_id", clientId);
            authUrl.searchParams.append("response_type", "code");
            authUrl.searchParams.append("redirect_uri", redirectUri);
            authUrl.searchParams.append("scope", scopes);
            authUrl.searchParams.append("code_challenge_method", "S256");
            authUrl.searchParams.append("code_challenge", codeChallenge);
            window.location = authUrl.toString();
        });

        logoutBtn.addEventListener("click", () => {
            localStorage.clear();
            window.location.reload();
        });

        // ===================================
        // FUNCIONES DE LA API DE SPOTIFY
        // ===================================
        
        async function callApi(endpoint, method, body) {
            const response = await fetch(`https://api.spotify.com/${endpoint}`, {
                method: method,
                headers: { 
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: body ? JSON.stringify(body) : null
            });
            // Manejar errores de la API
            if (!response.ok) {
                if (response.status === 401) {
                    await refreshToken(); // Intentar refrescar el token si es un error de autenticación
                    return await callApi(endpoint, method, body); // Reintentar la llamada
                }
                throw new Error(`Error de la API: ${response.status} ${response.statusText}`);
            }
            if (response.status === 204) {
                return {}; // No content response
            }
            return await response.json();
        }

        async function fetchAccessToken(code) {
            const codeVerifier = localStorage.getItem("code_verifier");
            const body = new URLSearchParams({
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: codeVerifier
            });
            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: body.toString()
            });
            return await response.json();
        }

        // ===================================
        // GESTIÓN DEL TOKEN
        // ===================================
        
        async function refreshToken() {
            const refreshToken = localStorage.getItem("refresh_token");
            if (!refreshToken) {
                throw new Error("No hay refresh token para refrescar la sesión.");
            }

            const body = new URLSearchParams({
                grant_type: "refresh_token",
                refresh_token: refreshToken,
                client_id: clientId
            });

            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: body.toString()
            });
            
            const data = await response.json();
            if (!response.ok) {
                localStorage.clear();
                window.location.reload();
                throw new Error("Error al refrescar el token. Se requiere un nuevo inicio de sesión.");
            }
            
            accessToken = data.access_token;
            localStorage.setItem("access_token", data.access_token);
        }

        async function getUserProfile() {
            return await callApi("v1/me", "GET");
        }
        
        async function getTopArtists() {
            return await callApi("v1/me/top/artists?limit=50&time_range=short_term", "GET");
        }

        async function getTopTracks() {
            return await callApi("v1/me/top/tracks?limit=50&time_range=short_term", "GET");
        }

        // ===================================
        // FUNCIONES CRUD DE PLAYLISTS
        // ===================================
        
        // CREATE: Crear una nueva playlist
        async function createPlaylist(name) {
            return await callApi(`v1/users/${userId}/playlists`, "POST", { name: name, public: true });
        }
        
        // READ: Obtener las playlists del usuario
        async function getUserPlaylists() {
            return await callApi("v1/me/playlists", "GET");
        }
        
        // UPDATE: Añadir canciones a una playlist
        async function addTracksToPlaylist(playlistId, trackUris) {
            return await callApi(`v1/playlists/${playlistId}/tracks`, "POST", { uris: trackUris });
        }

        // DELETE: Dejar de seguir una playlist (equivalente a "borrar" para el usuario)
        async function unfollowPlaylist(playlistId) {
            return await callApi(`v1/playlists/${playlistId}/followers`, "DELETE");
        }
        
        // ===================================
        // MANEJO DE LA UI Y LÓGICA DE LA APLICACIÓN
        // ===================================

        // Modales de mensaje personalizados
        function showMessage(title, text, type) {
            messageTitle.innerText = title;
            messageText.innerText = text;
            okBtn.classList.add("hidden");
            confirmBtn.classList.add("hidden");
            cancelBtn.classList.add("hidden");
            
            if (type === 'confirm') {
                confirmBtn.classList.remove("hidden");
                cancelBtn.classList.remove("hidden");
            } else {
                okBtn.classList.remove("hidden");
            }
            messageModal.classList.remove("hidden");
            return new Promise(resolve => {
                okBtn.onclick = () => {
                    messageModal.classList.add("hidden");
                    resolve(true);
                };
                confirmBtn.onclick = () => {
                    messageModal.classList.add("hidden");
                    resolve(true);
                };
                cancelBtn.onclick = () => {
                    messageModal.classList.add("hidden");
                    resolve(false);
                };
            });
        }
        
        function showLoading() {
            loadingSpinner.classList.remove("hidden");
            statsSection.classList.add("hidden");
            loginSection.classList.add("hidden");
        }

        function hideLoading() {
            loadingSpinner.classList.add("hidden");
            statsSection.classList.remove("hidden");
        }

        function showError(message) {
            showMessage("Error", message, 'alert');
            loginSection.classList.remove("hidden");
            statsSection.classList.add("hidden");
        }
        
        // Función para mostrar el contenido de las pestañas
        function showContent(tabId) {
            artistsContent.classList.add("hidden");
            tracksContent.classList.add("hidden");
            playlistsContent.classList.add("hidden");
            artistsTab.classList.remove("tab-active");
            tracksTab.classList.remove("tab-active");
            playlistsTab.classList.remove("tab-active");

            document.getElementById(tabId).classList.remove("hidden");
            document.getElementById(tabId.replace('-content', '-tab')).classList.add("tab-active");
        }
        
        function showArtists(artists) {
            artistsContent.innerHTML = '';
            artists.forEach((artist, index) => {
                const item = document.createElement("div");
                item.className = "flex flex-col items-center text-center p-4 bg-gray-800 rounded-lg transition-transform transform hover:scale-105";
                item.innerHTML = `
                    <div class="relative w-28 h-28 mb-3">
                        <img src="${artist.images[0]?.url || 'https://placehold.co/150x150/1DB954/white?text=Artist'}" 
                             alt="${artist.name}" class="rounded-full w-full h-full object-cover shadow-lg">
                        <span class="absolute -top-2 -right-2 bg-black text-spotify-green text-xs font-bold px-2 py-1 rounded-full border border-spotify-green">${index + 1}</span>
                    </div>
                    <p class="text-sm font-semibold truncate w-full">${artist.name}</p>
                    <p class="text-xs text-gray-400">${artist.genres[0] || 'Unknown'}</p>
                `;
                artistsContent.appendChild(item);
            });
        }

        function showTracks(tracks) {
            tracksContent.innerHTML = '';
            tracks.forEach((track, index) => {
                const item = document.createElement("div");
                item.className = "flex items-center space-x-4 p-4 bg-gray-800 rounded-lg transition-transform transform hover:scale-105";
                item.innerHTML = `
                    <span class="font-bold text-xl text-spotify-green">${index + 1}.</span>
                    <img src="${track.album.images[0]?.url || 'https://placehold.co/64x64/1DB954/white?text=Track'}" 
                             alt="${track.name}" class="w-16 h-16 rounded-lg object-cover">
                    <div class="flex-1">
                        <p class="text-sm font-semibold truncate">${track.name}</p>
                        <p class="text-xs text-gray-400 truncate">${track.artists.map(a => a.name).join(', ')}</p>
                    </div>
                `;
                tracksContent.appendChild(item);
            });
        }
        
        async function showPlaylists() {
            // Eliminar la llamada a showLoading(), ya que causa la pantalla negra
            userPlaylistsDiv.innerHTML = '<p class="text-center text-gray-400">Cargando playlists...</p>';
            try {
                const playlists = await getUserPlaylists();
                userPlaylistsDiv.innerHTML = '';
                if (playlists && playlists.items && playlists.items.length > 0) {
                    playlists.items.forEach(playlist => {
                        const playlistItem = document.createElement("div");
                        playlistItem.className = "flex items-center justify-between p-4 bg-gray-900 rounded-lg";
                        playlistItem.innerHTML = `
                            <div class="flex-1">
                                <p class="font-semibold">${playlist.name}</p>
                                <p class="text-xs text-gray-400">${playlist.tracks.total} canciones</p>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button data-playlist-id="${playlist.id}" class="update-btn bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-600 transition-colors">
                                    Actualizar
                                </button>
                                <button data-playlist-id="${playlist.id}" class="delete-btn bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-600 transition-colors">
                                    Eliminar
                                </button>
                            </div>
                        `;
                        userPlaylistsDiv.appendChild(playlistItem);
                    });

                    // Añadir listeners para los botones de Update y Delete
                    document.querySelectorAll(".update-btn").forEach(btn => {
                        btn.addEventListener("click", async (e) => {
                            try {
                                const playlistId = e.target.dataset.playlistId;
                                const topTracks = await getTopTracks();
                                const trackUris = topTracks.items.map(track => track.uri);
                                await addTracksToPlaylist(playlistId, trackUris);
                                showMessage("Éxito", "¡Playlist actualizada con tus 50 canciones más escuchadas!", 'alert');
                            } catch (error) {
                                console.error("Error al actualizar la playlist:", error);
                                showMessage("Error", "No se pudo actualizar la playlist. Por favor, inténtalo de nuevo.", 'alert');
                            }
                        });
                    });

                    document.querySelectorAll(".delete-btn").forEach(btn => {
                        btn.addEventListener("click", async (e) => {
                            const confirmDelete = await showMessage("Confirmar", "¿Estás seguro de que quieres eliminar esta playlist?", 'confirm');
                            if (confirmDelete) {
                                try {
                                    const playlistId = e.target.dataset.playlistId;
                                    await unfollowPlaylist(playlistId);
                                    showMessage("Éxito", "¡Playlist eliminada con éxito!", 'alert');
                                    showPlaylists(); // Volver a cargar la lista
                                } catch (error) {
                                    console.error("Error al eliminar la playlist:", error);
                                    showMessage("Error", "No se pudo eliminar la playlist. Por favor, inténtalo de nuevo.", 'alert');
                                }
                            }
                        });
                    });
                } else {
                    userPlaylistsDiv.innerHTML = '<p class="text-center text-gray-400">No se encontraron playlists.</p>';
                }
            } catch (error) {
                console.error("Error al cargar playlists:", error);
                showError("Error al cargar playlists. ¿Se ha revocado el permiso?");
            } finally {
                // hideLoading(); // Ya no es necesario
            }
        }
        
        // Listener para el botón de Create
        createPlaylistBtn.addEventListener("click", async () => {
            const playlistName = playlistNameInput.value.trim();
            if (playlistName.length < 3) {
                showMessage("Aviso", "El nombre de la playlist debe tener al menos 3 caracteres.", 'alert');
                return;
            }
            try {
                const newPlaylist = await createPlaylist(playlistName);
                const topTracks = await getTopTracks();
                const trackUris = topTracks.items.map(track => track.uri);
                await addTracksToPlaylist(newPlaylist.id, trackUris);
                showMessage("Éxito", "¡Playlist creada y actualizada con éxito!", 'alert');
                playlistNameInput.value = '';
                showPlaylists();
            } catch (error) {
                console.error("Error al crear la playlist:", error);
                showMessage("Error", "Error al crear la playlist. Por favor, asegúrate de tener los permisos correctos.", 'alert');
            }
        });

        // ===================================
        // LÓGICA PRINCIPAL (MANEJO DE LA CARGA DE LA PÁGINA)
        // ===================================

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            const codeVerifier = localStorage.getItem("code_verifier");
            const storedRefreshToken = localStorage.getItem("refresh_token");

            if (code && codeVerifier) {
                showLoading();
                try {
                    const tokenResponse = await fetchAccessToken(code);
                    if (tokenResponse.error) {
                        throw new Error(tokenResponse.error_description || "Error al obtener el token.");
                    }
                    accessToken = tokenResponse.access_token;
                    localStorage.setItem("access_token", accessToken);
                    if (tokenResponse.refresh_token) {
                        localStorage.setItem("refresh_token", tokenResponse.refresh_token);
                    }
                    
                    const [userData, topArtistsData, topTracksData] = await Promise.all([
                        getUserProfile(),
                        getTopArtists(),
                        getTopTracks()
                    ]);
                    userId = userData.id;

                    // Configurar la UI
                    loginSection.classList.add("hidden");
                    statsSection.classList.remove("hidden");
                    document.getElementById("user-image").src = userData.images[0]?.url || '';
                    document.getElementById("user-image").classList.remove("hidden");
                    document.getElementById("user-greeting").innerText = `Hola, ${userData.display_name}`;

                    // Inicializar listeners de pestañas
                    artistsTab.addEventListener("click", () => showContent('artists-content'));
                    tracksTab.addEventListener("click", () => showContent('tracks-content'));
                    playlistsTab.addEventListener("click", () => {
                        showContent('playlists-content');
                        showPlaylists();
                    });

                    // Mostrar los datos iniciales
                    showArtists(topArtistsData.items);
                    showTracks(topTracksData.items);
                    showContent('artists-content'); // Mostrar Artistas por defecto
                    
                } catch (error) {
                    console.error("Error en la autenticación o carga de datos:", error);
                    showError("Error al iniciar sesión. Intenta de nuevo.");
                } finally {
                    hideLoading();
                }
            } else if (storedRefreshToken) {
                    // Si hay un refresh token, intentamos obtener un nuevo access token
                try {
                    await refreshToken();
                    const userData = await getUserProfile();
                    userId = userData.id;
                    loginSection.classList.add("hidden");
                    statsSection.classList.remove("hidden");
                    document.getElementById("user-image").src = userData.images[0]?.url || '';
                    document.getElementById("user-image").classList.remove("hidden");
                    document.getElementById("user-greeting").innerText = `Hola, ${userData.display_name}`;
                    artistsTab.addEventListener("click", () => showContent('artists-content'));
                    tracksTab.addEventListener("click", () => showContent('tracks-content'));
                    playlistsTab.addEventListener("click", () => {
                        showContent('playlists-content');
                        showPlaylists();
                    });
                    const topArtistsData = await getTopArtists();
                    const topTracksData = await getTopTracks();
                    showArtists(topArtistsData.items);
                    showTracks(topTracksData.items);
                    showContent('artists-content');
                } catch (error) {
                    console.error("Error al refrescar el token:", error);
                    showError("La sesión ha expirado. Por favor, vuelve a iniciar sesión.");
                }
            } else {
                loginSection.classList.remove("hidden");
                statsSection.classList.add("hidden");
            }
        };
    </script>
</body>
</html>
