<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tus Estadísticas de Spotify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #ffffff;
        }
        .spotify-green {
            background-color: #1DB954;
        }
        .spotify-dark {
            background-color: #191414;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div id="app-container" class="w-full max-w-4xl p-8 rounded-lg shadow-xl spotify-dark">
        <!-- Contenido de la app -->
        <div id="login-section" class="flex flex-col items-center justify-center text-center">
            <h1 class="text-4xl font-bold mb-4">Tus Estadísticas de Spotify</h1>
            <p class="text-gray-400 mb-6">Inicia sesión para ver tus artistas y canciones más escuchadas.</p>
            <button id="login" class="spotify-green text-white font-bold py-3 px-8 rounded-full transition-transform transform hover:scale-105">
                Iniciar Sesión con Spotify
            </button>
        </div>
        
        <div id="stats-section" class="hidden">
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center">
                    <img id="user-image" src="" class="rounded-full w-12 h-12 mr-4 hidden"/>
                    <h2 id="user-greeting" class="text-2xl font-bold"></h2>
                </div>
                <button id="logout" class="bg-gray-700 text-white py-2 px-6 rounded-full hover:bg-gray-600 transition-colors">Cerrar Sesión</button>
            </header>
            
            <div class="flex justify-center mb-6 border-b border-gray-600">
                <button id="artists-tab" class="py-3 px-6 text-gray-400 font-semibold border-b-2 border-transparent transition-colors hover:text-white">Artistas</button>
                <button id="tracks-tab" class="py-3 px-6 text-gray-400 font-semibold border-b-2 border-transparent transition-colors hover:text-white">Canciones</button>
            </div>
            
            <div id="artists-content" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            <div id="tracks-content" class="hidden"></div>
        </div>
        
        <div id="loading-spinner" class="hidden flex justify-center mt-8">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-gray-200 border-t-spotify-green"></div>
        </div>
    </div>

    <script>
        // ===================================
        // CONFIGURACIÓN DE LA APLICACIÓN
        // ===================================
        const clientId = "682780c12e3047d2ad0986d34edd6c96";
        const redirectUri = "https://byblackjack19.github.io/rfid-dashboard/index.html";
        const scopes = "user-read-private user-read-email user-top-read";

        // ===================================
        // FUNCIONES DE AUTENTICACIÓN PKCE
        // ===================================

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function base64encode(buffer) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=+$/, "");
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest("SHA-256", data);
            return base64encode(digest);
        }

        // ===================================
        // GESTIÓN DEL FLUJO DE AUTENTICACIÓN
        // ===================================

        let codeVerifier = localStorage.getItem("code_verifier");
        const loginBtn = document.getElementById("login");
        const logoutBtn = document.getElementById("logout");
        const loginSection = document.getElementById("login-section");
        const statsSection = document.getElementById("stats-section");
        const loadingSpinner = document.getElementById("loading-spinner");
        const artistsTab = document.getElementById("artists-tab");
        const tracksTab = document.getElementById("tracks-tab");
        const artistsContent = document.getElementById("artists-content");
        const tracksContent = document.getElementById("tracks-content");

        loginBtn.addEventListener("click", async () => {
            codeVerifier = generateRandomString(128);
            localStorage.setItem("code_verifier", codeVerifier);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const authUrl = new URL("https://accounts.spotify.com/authorize");
            authUrl.searchParams.append("client_id", clientId);
            authUrl.searchParams.append("response_type", "code");
            authUrl.searchParams.append("redirect_uri", redirectUri);
            authUrl.searchParams.append("scope", scopes);
            authUrl.searchParams.append("code_challenge_method", "S256");
            authUrl.searchParams.append("code_challenge", codeChallenge);
            window.location = authUrl.toString();
        });

        logoutBtn.addEventListener("click", () => {
            localStorage.clear();
            window.location.reload();
        });

        // ===================================
        // FUNCIONES DE LA API DE SPOTIFY
        // ===================================

        async function fetchAccessToken(code) {
            const body = new URLSearchParams({
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: codeVerifier
            });
            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: body.toString()
            });
            return await response.json();
        }

        async function getUserProfile(token) {
            const response = await fetch("https://api.spotify.com/v1/me", {
                headers: { Authorization: `Bearer ${token}` }
            });
            return await response.json();
        }

        async function getTopArtists(token) {
            const response = await fetch("https://api.spotify.com/v1/me/top/artists?limit=50&time_range=short_term", {
                headers: { Authorization: `Bearer ${token}` }
            });
            return await response.json();
        }

        async function getTopTracks(token) {
            const response = await fetch("https://api.spotify.com/v1/me/top/tracks?limit=50&time_range=short_term", {
                headers: { Authorization: `Bearer ${token}` }
            });
            return await response.json();
        }

        // ===================================
        // MANEJO DE LA UI
        // ===================================

        function showLoading() {
            loadingSpinner.classList.remove("hidden");
            statsSection.classList.add("hidden");
            loginSection.classList.add("hidden");
        }

        function hideLoading() {
            loadingSpinner.classList.add("hidden");
        }

        function showArtists(artists) {
            artistsContent.innerHTML = '';
            artists.forEach((artist, index) => {
                const item = document.createElement("div");
                item.className = "flex flex-col items-center text-center p-4 bg-gray-800 rounded-lg transition-transform transform hover:scale-105";
                item.innerHTML = `
                    <div class="relative w-28 h-28 mb-3">
                        <img src="${artist.images[0]?.url || 'https://placehold.co/150x150/1DB954/white?text=Artist'}" 
                             alt="${artist.name}" class="rounded-full w-full h-full object-cover shadow-lg">
                        <span class="absolute -top-2 -right-2 bg-black text-spotify-green text-xs font-bold px-2 py-1 rounded-full border border-spotify-green">${index + 1}</span>
                    </div>
                    <p class="text-sm font-semibold truncate w-full">${artist.name}</p>
                    <p class="text-xs text-gray-400">${artist.genres[0] || 'Unknown'}</p>
                `;
                artistsContent.appendChild(item);
            });
        }

        function showTracks(tracks) {
            tracksContent.innerHTML = '';
            tracks.forEach((track, index) => {
                const item = document.createElement("div");
                item.className = "flex items-center space-x-4 p-4 bg-gray-800 rounded-lg transition-transform transform hover:scale-105";
                item.innerHTML = `
                    <span class="font-bold text-xl text-spotify-green">${index + 1}.</span>
                    <img src="${track.album.images[0]?.url || 'https://placehold.co/64x64/1DB954/white?text=Track'}" 
                         alt="${track.name}" class="w-16 h-16 rounded-lg object-cover">
                    <div class="flex-1">
                        <p class="text-sm font-semibold truncate">${track.name}</p>
                        <p class="text-xs text-gray-400 truncate">${track.artists.map(a => a.name).join(', ')}</p>
                    </div>
                `;
                tracksContent.appendChild(item);
            });
        }

        // ===================================
        // LÓGICA PRINCIPAL (MANEJO DE LA CARGA DE LA PÁGINA)
        // ===================================

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            const codeVerifier = localStorage.getItem("code_verifier");

            if (code && codeVerifier) {
                showLoading();
                try {
                    const tokenResponse = await fetchAccessToken(code);

                    if (tokenResponse.access_token) {
                        const [userData, topArtistsData, topTracksData] = await Promise.all([
                            getUserProfile(tokenResponse.access_token),
                            getTopArtists(tokenResponse.access_token),
                            getTopTracks(tokenResponse.access_token)
                        ]);
                        
                        // Configurar la UI
                        loginSection.classList.add("hidden");
                        statsSection.classList.remove("hidden");
                        document.getElementById("user-image").src = userData.images[0]?.url || '';
                        document.getElementById("user-image").classList.remove("hidden");
                        document.getElementById("user-greeting").innerText = `Hola, ${userData.display_name}`;

                        // Mostrar los datos
                        showArtists(topArtistsData.items);
                        
                        // Configurar las pestañas
                        artistsTab.classList.add("border-spotify-green", "text-white");
                        artistsTab.addEventListener("click", () => {
                            artistsTab.classList.add("border-spotify-green", "text-white");
                            tracksTab.classList.remove("border-spotify-green", "text-white");
                            artistsContent.classList.remove("hidden");
                            tracksContent.classList.add("hidden");
                        });
                        
                        tracksTab.addEventListener("click", () => {
                            tracksTab.classList.add("border-spotify-green", "text-white");
                            artistsTab.classList.remove("border-spotify-green", "text-white");
                            tracksContent.classList.remove("hidden");
                            artistsContent.classList.add("hidden");
                            showTracks(topTracksData.items);
                        });
                    }
                } catch (error) {
                    console.error("Error en la autenticación o carga de datos:", error);
                    document.getElementById("info-message").innerText = "Error al iniciar sesión. Intenta de nuevo.";
                } finally {
                    hideLoading();
                }
            } else {
                loginSection.classList.remove("hidden");
                statsSection.classList.add("hidden");
            }
        };
    </script>
</body>
</html>
